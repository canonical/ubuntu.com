{% extends "ceph/base_ceph.html" %}

{% block title %}Pricing Calculator | Ceph{% endblock %}

{% block body_class %}
  is-paper
{% endblock body_class %}

{% block meta_copydoc %}
  https://docs.google.com/spreadsheets/d/1cn5daIlWGpKF5557ERFY4Ok4_0IlJKTDbZjRXcXyhjk/edit?gid=471278338#gid=471278338
{% endblock meta_copydoc %}

{% block content %}
  <section class="p-section--hero">
    <div class="grid-row">
      <div class="grid-col-4">
        <h1>Calculate your storage costs</h1>
      </div>
      <div class="grid-col-4">
        <p>
          Cloud storage can make up a significant proportion of public cloud hosting costs, for some data sets it can be more cost effective to store them in a self-hosted storage system.
        </p>
        <p>
          Learn more in our <a href="/engage/optimize-cloud-storage-costs">white paper</a>, and explore potential savings with the calculator below.
        </p>
      </div>
    </div>
  </section>

  <form id="compare-costs-form">
    <section class="p-section--shallow">
      <div class="grid-row">
        <hr class="p-rule" />
        <div class="grid-col-4">
          <h2 class="p-heading--4">
            Self-managed, or <a href="/ceph/managed">managed</a> by Canonical experts?
          </h2>
        </div>
        <div class="grid-col-4">
          <label class="p-radio">
            <input type="radio"
                   class="p-radio__input"
                   name="managed"
                   aria-labelledby="managed"
                   value="managed"
                   checked="" />
            <span class="p-radio__label" id="managed">Managed</span>
          </label>
          <label class="p-radio">
            <input type="radio"
                   class="p-radio__input"
                   name="managed"
                   value="self-managed"
                   aria-labelledby="self-managed" />
            <span class="p-radio__label" id="self-managed">Self-managed</span>
          </label>
        </div>
      </div>
    </section>

    <section class="p-section--shallow">
      <div class="grid-row">
        <hr class="p-rule" />
        <div class="grid-col-4">
          <h2 class="p-heading--4">How many months do you expect to store this data?</h2>
        </div>
        <div class="grid-col-4">
          <div class="p-slider__wrapper">
            <span class="p-slider__min-value">12</span>
            <input type="range"
                   name="months"
                   min="12"
                   max="60"
                   value="12"
                   step="12"
                   id="month-slider"
                   aria-label="How many months do you expect to store this data?" />
            <span class="p-slider__max-value">60</span>
            <input class="p-slider__input"
                   type="text"
                   maxlength="5"
                   id="month-slider-input"
                   tabindex="0" />
          </div>
          <div class="p-notification--information is-borderless u-no-margin--bottom u-hide js-invalid-notification js-invalid-month-notification">
            <div class="p-notification__content">
              <p class="p-notification__message">
                The inputted value "<span class="js-notification-value"></span>" was corrected to the nearest allowed input
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="p-section--shallow">
      <div class="grid-row">
        <hr class="p-rule" />
        <div class="grid-col-4">
          <h2 class="p-heading--4">
            Choose the maximum amount of storage you need:
            <br />
            <span class="p-heading--4">(Petabytes (PB))</span>
          </h2>
        </div>
        <div class="grid-col-4">
          <div class="p-slider">
            <div class="p-slider__wrapper">
              <span class="p-slider__min-value">2.25</span>
              <input type="range"
                     name="storage"
                     min="2.25"
                     max="18"
                     value="2.25"
                     step="2.25"
                     id="storage-slider"
                     aria-label="Choose the maximum amount of storage you need" />
              <span class="p-slider__max-value">18</span>
              <input class="p-slider__input"
                     type="text"
                     maxlength="5"
                     id="storage-slider-input"
                     tabindex="0" />
            </div>
          </div>
          <div class="p-notification--information is-borderless u-no-margin--bottom u-hide js-invalid-notification js-invalid-storage-notification">
            <div class="p-notification__content">
              <p class="p-notification__message">
                The inputted value "<span class="js-notification-value"></span>" was corrected to the nearest allowed input
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </form>

  <section class="p-section--deep">
    <div class="u-fixed-width">
      <hr class="p-rule" />
      <div class="p-section--shallow">
        <h2>Compare your costs</h2>
      </div>
      <div class="p-section--shallow">
        <div class="p-pricing-block--50-50">
          <div class="p-pricing-block__tier">
            <div class="p-pricing-block__section">
              <hr class="p-rule--highlight u-no-margin--bottom" />
              <div class="p-section--shallow">
                <h3 class="p-heading--4">
                  Ceph self hosted cost
                  <br />
                  <strong id="ceph-cost">$0</strong>
                  <span class="u-text--muted">for <span id="ceph-months">0</span> months</span>
                </h3>
              </div>
            </div>
            <div class="p-pricing-block__section">
              <p class="u-text--muted">What's included</p>
              <div class="row">
                <div class="col-8">
                  <p id="ceph-deployment-label">Ceph Deployment</p>
                  <p id="hardware-maintenance-label">Hardware install and maintenance</p>
                  <p id="ubuntu-pro-label">Ubuntu Pro (managed or infra-Only)</p>
                  <p id="additional-storage-label">Ubuntu Pro (additional storage)</p>
                  <p id="hardware-label">Hardware</p>
                </div>
                <div class="col-3">
                  <p id="ceph-deployment-price" aria-describedby="ceph-deployment-label">$0</p>
                  <p id="hardware-maintenance-price"
                     aria-describedby="hardware-maintenance-label">$0</p>
                  <p id="ubuntu-pro-price" aria-describedby="ubuntu-pro-label">$0</p>
                  <p id="additional-storage-price"
                     aria-describedby="additional-storage-label">$0</p>
                  <p id="hardware-price" aria-describedby="hardware-label">$0</p>
                </div>
              </div>
            </div>
          </div>
          <div class="p-pricing-block__tier">
            <div class="p-pricing-block__section">
              <hr class="p-rule--highlight u-no-margin--bottom" />
              <div class="p-section--shallow">
                <h3 class="p-heading--4">
                  Public cloud provider cost
                  <br />
                  <strong id="public-cloud-cost">$0</strong>
                  <span class="u-text--muted">for <span id="cloud-months">0</span> months</span>
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="p-notification--information is-light">
        <div class="p-notification__content">
          <h5 class="p-notification__title">The cloud storage pricing calculator is for informational purposes only</h5>
          <p class="p-notification__message">
            Exact prices may vary depending on your specific requirements, performance needs and local cost conditions. The total costs include all CapEx and OpEx costs over the period selected, including reference hardware, hardware installation and maintenance, solution delivery, and support subscriptions. The total savings are calculated compared to reference pricing from a leading public cloud provider. In case of any questions, get in touch with our experts.
          </p>
        </div>
      </div>
    </div>
  </section>

  <script>
    const managedCephPerNodePerYear = 3485.0;
    const additionalStoragePerYear = 6050.0;
    const infraOnlyPerNodePerYear = 1500.0;
    const storageNodeCost = 86221.94;
    const managementNodeCost = 9801.89;
    const switchCost = 11308.0;

    const cephDeploymentCost = 50000;
    const hardwareMaintenanceCost = 25000;

    const capacityTable = [{
      capacity: 2.25,
      nodes: 6,
      switches: 3
    }, {
      capacity: 4.5,
      nodes: 12,
      switches: 3
    }, {
      capacity: 6.75,
      nodes: 18,
      switches: 3
    }, {
      capacity: 9,
      nodes: 24,
      switches: 3
    }, {
      capacity: 11.25,
      nodes: 30,
      switches: 6
    }, {
      capacity: 13.5,
      nodes: 36,
      switches: 6
    }, {
      capacity: 15.75,
      nodes: 42,
      switches: 6
    }, {
      capacity: 18,
      nodes: 48,
      switches: 6
    }, ];

    function initializeSliders() {
      var isWebkit =
        /Chrome/i.test(navigator.userAgent) || /Safari/i.test(navigator.userAgent);

      var PROGRESS_COLOUR = "#06c";
      var EMPTY_COLOUR = "#D9D9D9";

      /**
      Renders gradient to fake progress color in webkit browsers.
      @param {HTMLElement} slider Slider element to render background on.
      */
      function renderSlider(slider) {
        if (isWebkit) {
          var value = (slider.value - slider.min) / (slider.max - slider.min);
          slider.style.backgroundImage = (
            "-webkit-gradient(linear, left top, right top, color-stop(" +
            value + ", " + PROGRESS_COLOUR + "), color-stop(" +
            value + ", " + EMPTY_COLOUR + "))"
          );
        }
      }

      function equaliseValues(receive, give) {
        receive.value = give.value;
        give.value = receive.value;
      }

      function hideNotifications() {
        const notifications = document.querySelectorAll(".js-invalid-notification");
        notifications.forEach(notification => {
          notification.classList.add("u-hide");
        })
      }

      function showNotification(sliderId, value) {
        let notification;
        if (sliderId === "month-slider") {
          notification = document.querySelector(".js-invalid-month-notification");
        } else if (sliderId === "storage-slider") {
          notification = document.querySelector(".js-invalid-storage-notification");
        }

        if (notification) {
          notification.classList.remove("u-hide");
          const notificationValue = document.querySelector(".js-notification-value");
          notificationValue.innerHTML = value;
        }
      }

      /**
        Attaches change listener to sliders to update their background color.
        @param {HTMLElement} slider Slider element to render background on.
      */
      function initSlider(slider) {
        var input = document.getElementById(slider.id + "-input");
        renderSlider(slider);

        if (input) {
          equaliseValues(input, slider);

          function validateAndCorrect() {
            hideNotifications();

            if (!input.value) {
              input.value = slider.min;
            }
            // Find the next biggest available step value
            const value = parseFloat(input.value);
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const step = parseFloat(slider.step);

            let correctedValue;
            if (value > max) {
              correctedValue = max;
            } else {
              // Round up to the next value
              const steps = Math.ceil((value - min) / step);
              correctedValue = min + (steps * step);
            }

            const valueWasCorrected = value !== correctedValue;
            if (valueWasCorrected) {
              showNotification(slider.id, value);
            }

            input.value = correctedValue;
            equaliseValues(slider, input);
            renderSlider(slider);

            // Trigger an update
            slider.dispatchEvent(new Event("input"));
          }

          // Only apply the input value when leaving the input or clicking "enter"
          input.addEventListener("blur", validateAndCorrect);
          input.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
              validateAndCorrect();
            }
          });
        }

        slider.addEventListener('input', function() {
          if (input) {
            equaliseValues(input, slider);
          }
          renderSlider(slider);
        });
      }

      const compareCostsForm = document.querySelector("#compare-costs-form");
      compareCostsForm.addEventListener("click", function(e) {
        if (e.target.tagName === "INPUT") {
          hideNotifications();
        }
      })
      // Setup all sliders on the page.
      var sliders = document.querySelectorAll("input[type=range]");

      for (var i = 0, l = sliders.length; i < l; i++) {
        initSlider(sliders[i]);
      }
    }

    document.addEventListener("DOMContentLoaded", function() {

      const monthsInput = document.querySelector("input[name='months']");
      const storageInput = document.querySelector("input[name='storage']");
      const managedInputs = document.querySelectorAll("input[name='managed']");

      let selectedMonths = parseInt(
        monthsInput.value, 10
      );
      let selectedStorage = parseFloat(
        storageInput.value
      );
      let isManaged;
      managedInputs.forEach(input => {
        if (input.checked) {
          isManaged = input.value === "managed";
        }
      });


      function calculateCosts() {
        const capacitySpecs = capacityTable.find((row) => row.capacity === selectedStorage) || {};

        const nodes = capacitySpecs.nodes;
        const switches = capacitySpecs.switches;

        // Ceph self-hosted cost, see the formula in the spreadsheet copydoc
        // https://docs.google.com/spreadsheets/d/1cn5daIlWGpKF5557ERFY4Ok4_0IlJKTDbZjRXcXyhjk/edit?
        const ubuntuProCost = isManaged ?
          (nodes + 3) * managedCephPerNodePerYear * (selectedMonths / 12) :
          (nodes + 3) * infraOnlyPerNodePerYear * (selectedMonths / 12);

        const additionalStorageCost = nodes * additionalStoragePerYear * (selectedMonths / 12);

        const hardwareCost =
          nodes * storageNodeCost +
          managementNodeCost * 3 +
          switches * switchCost;

        const cephTotalCost = cephDeploymentCost + hardwareMaintenanceCost + ubuntuProCost + additionalStorageCost + hardwareCost;

        // Public cloud cost, see the formula in the spreadsheet copydoc
        const publicCloudCost =
          ((50 * 1024 * 0.023) +
            (450 * 1024 * 0.022) +
            ((selectedStorage * 1024 * 1024 - 500) * 0.021)) *
          selectedMonths;

        function formatCurrency(value) {
          return `$${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        document.getElementById("ceph-cost").textContent = formatCurrency(cephTotalCost);
        document.getElementById("ceph-months").textContent = selectedMonths;
        document.getElementById("public-cloud-cost").textContent = formatCurrency(publicCloudCost);
        document.getElementById("cloud-months").textContent = selectedMonths;

        document.getElementById("ceph-deployment-price").textContent = formatCurrency(cephDeploymentCost);
        document.getElementById("hardware-maintenance-price").textContent = formatCurrency(hardwareMaintenanceCost);
        document.getElementById("ubuntu-pro-price").textContent = formatCurrency(ubuntuProCost);
        document.getElementById("additional-storage-price").textContent = formatCurrency(additionalStorageCost);
        document.getElementById("hardware-price").textContent = formatCurrency(hardwareCost);
      }

      monthsInput.addEventListener("input", function() {
        console.log("test")
        selectedMonths = parseInt(this.value, 10);
        calculateCosts();
      });

      storageInput.addEventListener("input", function() {
        selectedStorage = parseFloat(this.value);
        calculateCosts();
      });

      managedInputs.forEach(input => {
        input.addEventListener("change", function() {
          isManaged = this.value === "managed";
          calculateCosts();
        });
      });

      calculateCosts();
    });

    initializeSliders();
  </script>

{% endblock content %}
