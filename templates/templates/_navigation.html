{% set breadcrumbs = get_navigation(request.path).breadcrumbs %}
<a href="#main-content" class="p-link--skip">Jump to main content</a>
<header id="navigation" class="p-navigation is-dark {% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}is-reduced {% elif breadcrumbs == 'tutorials' %}is-reduced{% endif %}">
  {% block header_banner %}
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo">
        <a class="p-navigation__link" href="/">
          {% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}
          Canonical Ubuntu
          {% elif breadcrumbs == "tutorials" %}
          Canonical Ubuntu
          {% else %}
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="https://assets.ubuntu.com/v1/82818827-CoF_white.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">Canonical Ubuntu</span>
          {% endif %}
        </a>
      </div>
      <ul class="p-navigation__items">
        <li class="p-navigation__item">
          <button class="js-search-button p-navigation__link--search-toggle">
            <span class="p-navigation__search-label">Search</span>
          </button>
        </li>
        <li class="p-navigation__item">
          <button class="js-menu-button p-navigation__link">Menu</button>
        </li>
      </ul>
    </div>
    <nav class="p-navigation__nav js-show-nav u-hide" aria-label="Categories">
      <ul class="p-navigation__items">
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="products" onmouseover="fetchDropdown('/templates/meganav/products', 'products-content'); this.onmouseover = null;">
          <a class="p-navigation__link" href="#products-content" onfocus="fetchDropdown('/templates/meganav/products', 'products-content');">Products</a>
          <div class="u-hide dropdown-content-mobile" id="products-content-mobile" onclick="event.stopPropagation()"></div>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="use-case" onmouseover="fetchDropdown('/templates/meganav/use-case', 'use-case-content'); this.onmouseover = null;">
          <a class="p-navigation__link" href="#use-case-content" onfocus="fetchDropdown('/templates/meganav/use-case', 'use-case-content');">Use Case</a>
          <div class="u-hide dropdown-content-mobile" id="use-case-content-mobile" onclick="event.stopPropagation()"></div>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="support" onmouseover="fetchDropdown('/templates/meganav/support', 'support-content'); this.onmouseover = null;">
          <a class="p-navigation__link" href="#support-content" onfocus="fetchDropdown('/templates/meganav/support', 'support-content');">Support</a>
          <div class="u-hide dropdown-content-mobile" id="support-content-mobile" onclick="event.stopPropagation()"></div>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="community" onmouseover="fetchDropdown('/templates/meganav/community', 'community-content'); this.onmouseover = null;">
          <a class="p-navigation__link" href="#community-content" onfocus="fetchDropdown('/templates/meganav/community', 'community-content');">Community</a>
          <div class="u-hide dropdown-content-mobile" id="community-content-mobile" onclick="event.stopPropagation()"></div>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="get-ubuntu" onmouseover="fetchDropdown('/templates/meganav/get-ubuntu', 'get-ubuntu-content'); this.onmouseover = null;">
          <a class="p-navigation__link" href="#get-ubuntu-content" onfocus="fetchDropdown('/templates/meganav/get-ubuntu', 'get-ubuntu-content');">Get Ubuntu</a>
          <div class="u-hide dropdown-content-mobile" id="get-ubuntu-content-mobile" onclick="event.stopPropagation()"></div>
        </li>
      </ul>
      <ul class="p-navigation__items global-nav">
        <li class="p-navigation__item">
          <button href="#" class="js-search-button p-navigation__link--search-toggle">
            <span class="p-navigation__search-label">Search</span>
          </button>
        </li>
        <li class="p-navigation__user js-account" id="canonical-login"></li>
      </ul>
      <div class="p-navigation__search">
        <form action="/search" class="p-search-box">
          <input type="search" class="p-search-box__input" name="q" placeholder="Search our sites" required="" aria-label="Search our sites">
          <button type="reset" class="p-search-box__reset"><i class="p-icon--close"></i></button>
          <button type="submit" class="p-search-box__button"><i class="p-icon--search"></i></button>
        </form>
      </div>
    </nav>
  </div>
  {% endblock header_banner %}
  <div class="p-navigation__search-overlay"></div>
</header>
<div class="dropdown-window-overlay fade-animation"></div>
<div class="dropdown-window slide-animation {% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}is-reduced {% elif breadcrumbs == 'tutorials' %}is-reduced{% endif %}">
  <div class="u-hide dropdown-content-desktop" id="products-content"></div>
  <div class="u-hide dropdown-content-desktop" id="use-case-content"></div>
  <div class="u-hide dropdown-content-desktop" id="support-content"></div>
  <div class="u-hide dropdown-content-desktop" id="community-content"></div>
  <div class="u-hide dropdown-content-desktop" id="download-content"></div>
</div>
{% if not(hide_subnav == True) %}
{% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}
<div id="secondary-navigation" class="p-navigation is-secondary is-dark">
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__tagged-logo">
        <a class="p-navigation__link" href="{{ breadcrumbs.section.path }}">
          <div class="p-navigation__logo-tag">
            <img class="p-navigation__logo-icon" src="https://assets.ubuntu.com/v1/82818827-CoF_white.svg" alt="">
          </div>
          <span class="p-navigation__logo-title">{{ breadcrumbs.section.title | replace(" ", "&nbsp;") | safe }}</span>
        </a>
      </div>
      <div class="u-hide js-account--small"></div>
      <a href="#" class="p-navigation__toggle--open" title="Toggle navigation"><i class="p-icon--chevron-down is-light"></i></a>
    </div>

    <nav class="p-navigation__nav" aria-label="{{ breadcrumbs.section.title | replace(' ', '&nbsp;') | safe }} navigation">
      {% if breadcrumbs.children %}
      <ul class="p-navigation__items">
        {% for child in breadcrumbs.children %}
          {% if child.title != "Overview" %}
            {% if child.path == '/blog/topics' %}
            <li class="p-navigation__item  {% if child.active %}is-selected{% endif %}" style="position: relative;">
              <a aria-controls="#topics" data-trigger="hover" class="p-navigation__link  p-contextual-menu__toggle" href="#">{{ child.title }}</a>
              <span class="p-contextual-menu__dropdown" id="topics" aria-hidden="true" aria-label="submenu" style="position: absolute; font-size: .875rem;">
                <span class="p-contextual-menu__group">
                  {% for item in child.children %}
                  <a href="{{ item.path }}" class="p-contextual-menu__link breadcrumbs p-link--soft">{{ item.title }}</a>
                  {% endfor %}
                </span>
              </span>
            </li>
            {% elif child.path != '/blog/archives' and child.path != '/blog/upcoming' %}
            <li class="p-navigation__item {% if child.active %}is-selected{% endif %}">
              <a class="p-navigation__link" href="{{ child.path }}" {% if child.active %}aria-current="page"{% endif %}>{{ child.title }}</a>
            </li>
            {% endif %}
          {% endif %}
        {% endfor %}

        {% for child in breadcrumbs.children %}
          {% if child.path == "/blog/topics" %}
            {% for item in child.children %}
            <li class="p-navigation__item u-hide--medium u-hide--large {% if request.path == item.path %}is-selected{% endif %}">
              <a class="p-navigation__link" href="{{ item.path }}">{{ item.title }}</a>
            </li>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </ul>
      {% endif %}
    </nav>
  </div>
</div>
{% endif %}
{% endif %}
<script>
  const nav = document.querySelector('.js-show-nav');
  const currentBubble = window.location.pathname.split('/')[1]
  const skipLink = document.querySelector('.p-link--skip');
  const reducedNav = document.querySelector('.p-navigation.is-reduced ')

  nav.classList.remove('u-hide')

  checkTopNav();

  document.addEventListener('wheel', function(e) {
    if (window.scrollY <= 0) {
      revealTopNav();
    }
  });

  document.addEventListener('scroll', function(e) {
    if (window.scrollY <= 0) {
      revealTopNav();
    }
  });

  if (skipLink) {
    skipLink.addEventListener('focus', function(e) {
      if (window.scrollY <= 0) {
        revealTopNav();
      }
    })
  }
  
  if (reducedNav) {
    reducedNav.addEventListener('focus', function(e) {
      if (window.scrollY <= 0) {
        revealTopNav();
      }
    })
  }

  // if the user has previously visited a page in the same bubble,
  // and scrolled up to reveal the reduced nav, show the nav on
  // pages within the same bubble
  function checkTopNav() {
    const lastBubble = sessionStorage.getItem('navBubble');

    if (lastBubble === currentBubble) {
      document.body.classList.add('navigation-lock');
    }
  }

  function revealTopNav() {
    document.body.style.marginTop = 0;
    sessionStorage.setItem('navBubble', currentBubble)
  }
  
  function fetchDropdown(url, id) {
    var mobile = document.getElementById(id+"-mobile");
    var div = document.getElementById(id);

    if (div.innerHTML === "") {
      var req = new XMLHttpRequest();
      req.open('GET', url);
      req.send();
      req.addEventListener('load', function() {
        div.innerHTML = this.responseText;
      });
      req.addEventListener('load', function() {
        mobile.innerHTML = this.responseText;

        var activeCTAs = mobile.querySelectorAll('a.is-active');

        activeCTAs.forEach((cta) => {
          cta.classList.remove('is-active');
        })
      });
    }
  }

  function initNavigationSearch(element) {
  const searchButtons = element.querySelectorAll('.js-search-button');

  searchButtons.forEach((searchButton) => {
    searchButton.addEventListener('click', toggleSearch);
  });

  const menuButton = element.querySelector('.js-menu-button');
  if (menuButton) {
    menuButton.addEventListener('click', toggleMenu);
  }

  const overlay = element.querySelector('.p-navigation__search-overlay');
  if (overlay) {
    overlay.addEventListener('click', closeAll);
  }

  function toggleMenu(e) {
    e.preventDefault();

    var navigation = e.target.closest('.p-navigation');
    if (navigation.classList.contains('has-menu-open')) {
      var mobileContent = document.querySelector('.dropdown-content-mobile')
      mobileContent.classList.add('u-hide')
      closeAll();
    } else {
      closeAll();
      openMenu(e);
    }
  }

  function toggleSearch(e) {
    e.preventDefault();

    var navigation = e.target.closest('.p-navigation');
    if (navigation.classList.contains('has-search-open')) {
      closeAll();
    } else {
      closeAll();
      openSearch(e);
    }
  }

  function openSearch(e) {
    e.preventDefault();
    var navigation = e.target.closest('.p-navigation');
    var nav = navigation.querySelector('.p-navigation__nav');

    var searchInput = navigation.querySelector('.p-search-box__input');
    var buttons = document.querySelectorAll('.js-search-button');
    var secondaryNav = document.querySelector(".is-secondary")

    buttons.forEach((searchButton) => {
      searchButton.setAttribute('aria-pressed', true);
    });

    navigation.classList.add('has-search-open');
    if(secondaryNav){
      secondaryNav.classList.add('u-hide');
    }
    searchInput.focus();
    document.addEventListener('keyup', keyPressHandler);
  }

  function openMenu(e) {
    e.preventDefault();
    var navigation = e.target.closest('.p-navigation');
    var nav = navigation.querySelector('.p-navigation__nav');

    var buttons = document.querySelectorAll('.js-menu-button');

    buttons.forEach((searchButton) => {
      searchButton.setAttribute('aria-pressed', true);
    });

    navigation.classList.add('has-menu-open');
    document.addEventListener('keyup', keyPressHandler);
  }

  function closeSearch() {
    var navigation = document.querySelector('.p-navigation');
    var nav = navigation.querySelector('.p-navigation__nav');

    var banner = document.querySelector('.p-navigation__banner');
    var buttons = document.querySelectorAll('.js-search-button');

    buttons.forEach((searchButton) => {
      searchButton.removeAttribute('aria-pressed');
    });
    var secondaryNav = document.querySelector(".is-secondary")

    navigation.classList.remove('has-search-open');
    if(secondaryNav){
      secondaryNav.classList.remove('u-hide');
    }
    document.removeEventListener('keyup', keyPressHandler);
  }

  function closeMenu() {
    var navigation = document.querySelector('.p-navigation');
    var nav = navigation.querySelector('.p-navigation__nav');

    var banner = document.querySelector('.p-navigation__banner');
    var buttons = document.querySelectorAll('.js-menu-button');
    var dropdownWindow =  document.querySelector('.dropdown-window');
    var dropdownWindowOverlay = document.querySelector(".dropdown-window-overlay");
    var reducedNavItems = document.querySelectorAll('[role="menuitem"]');
    dropdownWindow.classList.add("slide-animation");
    dropdownWindowOverlay.classList.add("fade-animation");

    reducedNavItems.forEach( item => {
      if (item.classList.contains("is-selected")){
        item.classList.remove("is-selected");
      }
    });

    [].slice.call(dropdownWindow.children).forEach( dropdownContent => {
        if (dropdownContent.classList.contains("u-hide") === false) {
          dropdownContent.classList.add("u-hide");
        }
      }
    )

    buttons.forEach((searchButton) => {
      searchButton.removeAttribute('aria-pressed');
    });

    navigation.classList.remove('has-menu-open');
    document.removeEventListener('keyup', keyPressHandler);
  }

  function closeAll() {
    closeSearch();
    closeMenu();
  }

  function keyPressHandler(e) {
    if (e.key === 'Escape') {
      closeAll();
    }
  }
}

var navigation = document.querySelector('#navigation');
initNavigationSearch(navigation);

function toggleDropdown(toggle, open) {
  var parentElement = toggle.parentNode;
  var dropdownWindow =  document.querySelector('.dropdown-window');
  var dropdown = document.getElementById(toggle.getAttribute('aria-controls'));
  dropdown.setAttribute('aria-hidden', !open);

  if (open) {
    parentElement.classList.add('is-active');
    [].slice.call(dropdownWindow.children).forEach( dropdownContent => {
      if (dropdownContent.classList.contains("u-hide") === false) {
        dropdownContent.classList.add("u-hide");
      }
    })
  } else {
    parentElement.classList.remove('is-active');
  }
}

function closeAllDropdowns(toggles) {
  toggles.forEach(function (toggle) {
    toggleDropdown(toggle, false);
  });
}

function handleClickOutside(toggles, containerClass) {
  document.addEventListener('click', function (event) {
    var target = event.target;

    if (target.closest) {
      if (!target.closest(containerClass)) {
        closeAllDropdowns(toggles);
      }
    }
  });
}

function showSection(e) {
  const nav = document.querySelector('.p-navigation');
  const target = e.target.getAttribute('aria-controls');
  const el = document.getElementById(target);
  
  el.removeAttribute('hidden');

  setTimeout(function () {
    nav.classList.add('subsection-active');
    el.classList.add('is-active');
  }, 1);
}

function hideSection(e) {
  e.preventDefault();
  const nav = document.querySelector('.p-navigation');
  const target = e.target.getAttribute('aria-controls');
  const el = document.getElementById(target)

  nav.classList.remove('subsection-active');
  el.classList.remove('is-active');

  setTimeout(function () {
    el.setAttribute('hidden', true);
  }, 333);
}

function initNavDropdowns(containerClass) {
  var toggles = [].slice.call(document.querySelectorAll(containerClass + ' [aria-controls]'));

  handleClickOutside(toggles, containerClass);

  toggles.forEach(function (toggle) {
    toggle.addEventListener('click', function (e) {
      e.preventDefault();

      closeAllDropdowns(toggles);
      toggleDropdown(toggle, true);
    });
  });
}

initNavDropdowns('.p-navigation__item--dropdown-toggle')
</script>