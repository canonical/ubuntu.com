{% set breadcrumbs = get_navigation(request.path).breadcrumbs %}

<header id="navigation" class="p-navigation is-dark">
  {% block header_banner %}
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__logo">
        <a class="p-navigation__item" href="/" alt="Home">
          <small>(Logo to come)</small>
        </a>

        {% if breadcrumbs %}
        <h5 class="p-navigation--secondary__logo u-hide--nav-threshold-up">
          <a class="p-navigation--secondary__banner" href="{{ breadcrumbs.section.path }}{% if get_test_backend %}?test_backend=true{% endif %}">
            {{ breadcrumbs.section.title }}
          </a>
        </h5>
        {% endif %}

        {% if section_title and section_path %}
        <h5 class="p-navigation--secondary__logo u-hide--nav-threshold-up">
          <a class="p-navigation--secondary__banner" href="{{ section_path }}">
            {{ section_title }}
          </a>
        </h5>
        {% endif %}
      </div>
      <div class="u-hide u-show--small js-account--small"></div>
    </div>
    <nav class="p-navigation__nav">
      <ul class="p-navigation__items js-show-nav u-hide" role="menu">
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="get-ubuntu">
          <a class="p-navigation__link" href="#get-ubuntu-content">Get Ubuntu</a>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="products">
          <a class="p-navigation__link" href="#products-content">Products</a>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="use-case">
          <a class="p-navigation__link" href="#use-case-content">Use case</a>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="support">
          <a class="p-navigation__link" href="#support-content">Support</a>
        </li>
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="community">
          <a class="p-navigation__link" href="#community-content">Community</a>
        </li>
      </ul>
      <noscript>
        <ul class="p-navigation__items" role="menu">
          {% include "templates/header_noscript.html" %}
        </ul>
      </noscript>
      <ul class="p-navigation__items u-hide--small">
        <li class="p-navigation__item--dropdown-toggle" role="menuitem" id="canonical">
          <a class="p-navigation__link" href="#canonical-content">Canonical</a>
        </li>
        <li class="p-navigation__item" id="link-4">
          <a href="/search" class="js-search-button p-navigation__link" style="padding-right: 1rem;">
            <i class="p-icon--search is-light">Search</i>
          </a>
        </li>
        <li class="p-navigation__user js-account"></li>
      </ul>
      <div class="p-navigation__search u-show--small u-hide" style="z-index: 39;">
        <form action="/search" class="p-search-box" id="ubuntu-global-search-form">
          <input type="search" class="p-search-box__input" name="q" placeholder="Search our sites" required="" aria-label="Search our sites">
          <button type="reset" class="p-search-box__reset"><i class="p-icon--close"></i></button>
          <button type="submit" class="p-search-box__button"><i class="p-icon--search">Search</i></button>
        </form>
      </div>
    </nav>
  </div>
  {% endblock header_banner %}
</header>
<div class="dropdown-window-overlay fade-animation"></div>
<div class="dropdown-window slide-animation">
  <div class="u-hide" id="get-ubuntu-content">
    {% include "templates/nav-prototype/get-ubuntu/main.html" %}
  </div>
  <div class="u-hide" id="products-content">
    {% include "templates/nav-prototype/products/main.html" %}
  </div>
  <div class="u-hide" id="use-case-content">
    {% include "templates/nav-prototype/use-case/main.html" %}
  </div>
  <div class="u-hide" id="support-content">
    {% include "templates/nav-prototype/support/main.html" %}
  </div>
  <div class="u-hide" id="community-content">
    {% include "templates/nav-prototype/community/main.html" %}
  </div>
  <div class="u-hide" id="canonical-content">
    {% include "templates/nav-prototype/canonical/main.html" %}
  </div>
</div>
{% if not(hide_subnav == True) %}
  {% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}
  <nav class="p-navigation--secondary">
    <div class="row">
      <div class="col-12 u-equal-height">
        <a class="p-navigation--secondary__banner u-hide--nav-threshold-down" href="{{ breadcrumbs.section.path }}{% if get_test_backend %}?test_backend=true{% endif %}">
          <h5 class="p-navigation--secondary__logo">
            {{ breadcrumbs.section.title | replace(" ", "&nbsp;") | safe }}
          </h5>
        </a>
        {% if breadcrumbs.children %}
        <ul class="breadcrumbs--secondary">
          {% for child in breadcrumbs.children %}
            {% if child.path == '/blog/topics' %}
            <li class="breadcrumbs__item p-contextual-menu u-hide--small">
              <a aria-controls="#topics" data-trigger="hover" class="breadcrumbs__link u-no-margin--bottom {% if child.active %}p-link--active{% else %}p-link--soft{% endif %} p-contextual-menu__toggle" href="#">{{ child.title }}</a>

              <span class="p-contextual-menu__dropdown" id="topics" aria-hidden="true" aria-label="submenu" style="left: 1rem; font-size: .875rem;">
                <span class="p-contextual-menu__group">
                  {% for item in child.children %}
                  <a href="{{ item.path }}" class="p-contextual-menu__link breadcrumbs p-link--soft">{{ item.title }}</a>
                  {% endfor %}
                </span>
              </span>
            </li>
            {% elif child.path != '/blog/archives' and child.path != '/blog/upcoming' %}
            <li class="breadcrumbs__item">
              <a class="breadcrumbs__link {% if child.active %}p-link--active{% else %}p-link--soft{% endif %}" href="{{ child.path }}{% if get_test_backend %}?test_backend=true{% endif %}" {% if child.active %}aria-current="page"{% endif %}>{{ child.title }}</a>
            </li>
            {% endif %}

            {% if breadcrumbs.grandchildren %}
            <li class="breadcrumbs__item"><span class="breadcrumbs__chevron u-hide--small">&rsaquo;</span><span class="u-show--small">&nbsp;</span></li>
              {% for grandchild in breadcrumbs.grandchildren %}
              <li class="breadcrumbs__item">
                <a class="breadcrumbs__link {% if grandchild.active %}p-link--active{% else %}p-link--soft{% endif %}" href="{{ grandchild.path }}">
                  {{ grandchild.title }}
                </a>
              </li>
              {% endfor %}
            {% endif %}
          {% endfor %}

          {% for child in breadcrumbs.children %}
            {% if child.path == "/blog/topics" %}
              {% for item in child.children %}
              <li class="breadcrumbs__item u-hide--medium u-hide--large">
                <a class="breadcrumbs__link {% if request.path == item.path %}p-link--active{% else %}p-link--soft {% endif %}" href="{{ item.path }}">{{ item.title }}</a>
              </li>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>
  </nav>
  {% endif %}
{% endif %}

<script>
  (function () {
    var keys = {
      left: 'ArrowLeft',
      right: 'ArrowRight',
    };

    var direction = {
      ArrowLeft: -1,
      ArrowRight: 1,
    };

    // IE11 doesn't support event.code, but event.keyCode is
    // deprecated in most modern browsers, so we should support
    // both for the time being.
    var IEKeys = {
      left: 37,
      right: 39,
    };

    var IEDirection = {
      37: direction['ArrowLeft'],
      39: direction['ArrowRight'],
    };

    /**
      Attaches a number of events that each trigger
      the reveal of the chosen tab content
      @param {Array} tabs an array of tabs within a container
    */
    function attachEvents(tabs) {
      tabs.forEach(function (tab, index) {
        tab.addEventListener('keyup', function (e) {
          var compatibleKeys = IEKeys;
          var key = e.keyCode;

          if (e.code) {
            compatibleKeys = keys;
            key = e.code;
          }

          if (key === compatibleKeys.left || key === compatibleKeys.right) {
            switchTabOnArrowPress(e, tabs);
          }
        });

        tab.addEventListener('click', function (e) {
          e.preventDefault();
          setActiveTab(tab, tabs);
        });

        tab.addEventListener('focus', function () {
          setActiveTab(tab, tabs);
        });

        tab.index = index;
      });
    }

    /**
      Determine which tab to show when an arrow key is pressed
      @param {KeyboardEvent} event
      @param {Array} tabs an array of tabs within a container
    */
    function switchTabOnArrowPress(event, tabs) {
      var compatibleKeys = IEKeys;
      var compatibleDirection = IEDirection;
      var pressed = event.keyCode;

      if (event.code) {
        compatibleKeys = keys;
        compatibleDirection = direction;
        pressed = event.code;
      }

      if (compatibleDirection[pressed]) {
        var target = event.target;
        if (target.index !== undefined) {
          if (tabs[target.index + compatibleDirection[pressed]]) {
            tabs[target.index + compatibleDirection[pressed]].focus();
          } else if (pressed === compatibleKeys.left) {
            tabs[tabs.length - 1].focus();
          } else if (pressed === compatibleKeys.right) {
            tabs[0].focus();
          }
        }
      }
    }

    /**
      Cycles through an array of tab elements and ensures 
      only the target tab and its content are selected
      @param {HTMLElement} tab the tab whose content will be shown
      @param {Array} tabs an array of tabs within a container
    */
    function setActiveTab(tab, tabs) {
      tabs.forEach(function (tabElement) {
        var tabContent = document.getElementById(tabElement.getAttribute('aria-controls'));

        if (tabElement === tab) {
          tabElement.setAttribute('aria-selected', true);
          tabContent.removeAttribute('hidden');
        } else {
          tabElement.setAttribute('aria-selected', false);
          tabContent.setAttribute('hidden', true);
        }
      });
    }

    /**
      Attaches events to tab links within a given parent element,
      and sets the active tab if the current hash matches the id
      of an element controlled by a tab link
      @param {String} selector class name of the element 
      containing the tabs we want to attach events to
    */
    function initTabs(selector) {
      var tabContainers = [].slice.call(document.querySelectorAll(selector));

      tabContainers.forEach(function (tabContainer) {
        var tabs = [].slice.call(tabContainer.querySelectorAll('[aria-controls]'));
        attachEvents(tabs);
      });
    }
  })();
</script>

<script>
  var nav = document.querySelector('.js-show-nav');
  var hash = window.location.hash;
  nav.classList.remove('u-hide');

  // If the page loads with a preselected hash load and open the menu
  if (hash) {
    try {
      var selected = nav.querySelector(hash);
    } catch(error) {
      console.warn("Hash " + hash + " not found in topnav");
    }
    if (selected) {
      selected.onmouseover();
    }
  }

  function fetchDropdown(url, id) {
    var div = document.getElementById(id);
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.send();
    req.addEventListener('load', function() {
      div.innerHTML = this.responseText;
    });
  }

  function initSearch() {
    var searchButton = document.querySelector('.js-search-button');
    var searchReset = document.querySelector('.p-search-box__reset');
    if (searchButton) {
      searchButton.addEventListener('click', openSearch);
    }

    if (searchReset) {
      searchReset.addEventListener('click', closeSearch);
    }
  }
  
  function openSearch(e) {
    e.preventDefault();
    var navigation = document.querySelector('.p-navigation__nav');
    var dropdownWindowOverlay = document.querySelector(".dropdown-window-overlay");
    var banner = document.querySelector(".p-navigation__banner");
    var dropdownWindow = document.querySelector(".dropdown-window");
    var navigationItems = document.querySelector('.p-navigation__items');
    var searchButton = document.querySelector('.js-search-button');
    var search = document.querySelector('.p-navigation__search');
    var searchInput = document.querySelector('.p-search-box__input');
    var searchActive = !search.classList.contains('u-hide');
    search.classList.remove('u-hide');
    searchButton.classList.add('u-hide');
    banner.style= "opacity: 0.4; transition: opacity 0.5s ease-in-out;"
    navigationItems.style= "opacity: 0.4; transition: opacity 0.5s ease-in-out;"
    dropdownWindow.style="z-index: 37;"
    dropdownWindowOverlay.classList.remove("fade-animation");
    navigation.classList.add('has-active-search');
    searchInput.focus();
    dropdownWindowOverlay.addEventListener('click', closeSearch);
    document.addEventListener('keyup', keyPressHandler);
  }

  function closeSearch() {
    var navigation = document.querySelector('.p-navigation__nav');
    var banner = document.querySelector(".p-navigation__banner")
    var dropdownWindow = document.querySelector(".dropdown-window");
    var dropdownWindowOverlay = document.querySelector(".dropdown-window-overlay");
    var navigationItems = document.querySelector('.p-navigation__items');
    var searchButton = document.querySelector('.js-search-button');
    var search = document.querySelector('.p-navigation__search');
    search.classList.add('u-hide');
    banner.style= "opacity: 1;"
    dropdownWindow.style="z-index: 39;"
    navigationItems.style= "opacity: 1;"
    dropdownWindowOverlay.classList.add("fade-animation");
    navigation.classList.remove('has-active-search');
    searchButton.classList.remove('u-hide');
    document.removeEventListener('keyup', keyPressHandler);
    dropdownWindowOverlay.removeEventListener('click', closeSearch);
  }

  function keyPressHandler (e) {
    if (e.key === "Escape") {
      closeSearch();
    }
  }

  initSearch();
</script>