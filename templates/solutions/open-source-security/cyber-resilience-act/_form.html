<div class="p-modal" id="modal">
  <section class="p-modal__dialog"
           role="dialog"
           aria-modal="true"
           aria-labelledby="modal-title"
           aria-describedby="modal-description">
    <form action="/marketo/submit" method="post" id="mktoForm_6051">
      <header class="p-modal__header">
        <h2 class="p-modal__title" id="modal-title">
          Get in touch with our experts on the Cyber Resilience Act (CRA) compliance
        </h2>
        <button class="p-modal__close"
                aria-label="Close active modal"
                aria-controls="modal"
                onclick="closeModal">Close</button>
      </header>
      <p id="modal-description">Fill in this form and a member of our team will be in touch shortly.</p>
      <ul class="p-list">
        <li class="p-list__item">
          <label for="InputFirstName">First name</label>
          <input type="text" id="InputFirstName" name="InputFirstName" required />
        </li>
        <li class="p-list__item">
          <label for="InputLastName">Last name</label>
          <input type="text" id="InputLastName" name="InputLastName" required />
        </li>
        <li class="p-list__item">
          <label for="InputEmail">Email address</label>
          <input type="email"
                 id="InputEmail"
                 name="InputEmail"
                 placeholder="example@canonical.com"
                 autocomplete="email"
                 required />

        </li>
        <li class="p-list__item">
          <label for="InputPhoneNumber">Phone number</label>
          <input type="tel" id="InputPhoneNumber" name="InputPhoneNumber" />

        </li>
        <li class="p-list__item">
          <label for="InputCompany">Company</label>
          <input type="text" id="InputCompany" name="InputCompany" />
        </li>
        <li class="p-list__item">
          <label for="InputJobTitle">Job title</label>
          <input type="text" id="InputJobTitle" name="InputJobTitle" />

        </li>
        <li class="p-list__item">

          <label class="p-checkbox">
            <input class="p-checkbox__input"
                   aria-labelledby="canonicalUpdatesOptIn"
                   name="canonicalUpdatesOptIn"
                   type="checkbox" />
            <span class="p-checkbox__label" id="canonicalUpdatesOptIn">
              I agree to receive information about Canonical's products and services.
              By submitting this form, I confirm that I have read and agree to <a href="/legal/dataprivacy">Canonical's Privacy Policy</a>.
            </span>
          </label>
        </li>
        {# These are honey pot fields to catch bots #}
        <li class="u-off-screen">
          <label class="website" for="website">Website:</label>
          <input name="website"
                 type="text"
                 class="website"
                 autocomplete="off"
                 value=""
                 id="website"
                 tabindex="-1" />
        </li>
        <li class="u-off-screen">
          <label class="name" for="name">Name:</label>
          <input name="name"
                 type="text"
                 class="name"
                 autocomplete="off"
                 value=""
                 id="name"
                 tabindex="-1" />
        </li>
        {# End of honey pots #}
        <input type="hidden"
               aria-hidden="true"
               aria-label="hidden field"
               name="formid"
               value="6051" />
        <input type="hidden"
               aria-hidden="true"
               aria-label="hidden field"
               name="returnURL"
               value="/solutions/open-source-security/cyber-resilience-act/thank-you.html" />
      </ul>

      <footer class="p-modal__footer">
        <button class="u-no-margin--bottom" aria-controls="modal" type="reset">Cancel</button>
        <button class="p-button--negative u-no-margin--bottom" type="submit">Submit</button>
      </footer>
    </form>
  </section>
</div>
<script>
  (function() {
    var currentDialog = null;
    var lastFocus = null;
    var ignoreFocusChanges = false;
    var focusAfterClose = null;

    // Traps the focus within the currently open modal dialog
    function trapFocus(event) {
      if (ignoreFocusChanges) return;

      if (currentDialog.contains(event.target)) {
        lastFocus = event.target;
      } else {
        focusFirstDescendant(currentDialog);
        if (lastFocus == document.activeElement) {
          focusLastDescendant(currentDialog);
        }
        lastFocus = document.activeElement;
      }
    }

    // Attempts to focus given element
    function attemptFocus(child) {
      if (child.focus) {
        ignoreFocusChanges = true;
        child.focus();
        ignoreFocusChanges = false;
        return document.activeElement === child;
      }

      return false;
    }

    // Focuses first child element
    function focusFirstDescendant(element) {
      for (var i = 0; i < element.childNodes.length; i++) {
        var child = element.childNodes[i];
        if (attemptFocus(child) || focusFirstDescendant(child)) {
          return true;
        }
      }
      return false;
    }

    // Focuses last child element
    function focusLastDescendant(element) {
      for (var i = element.childNodes.length - 1; i >= 0; i--) {
        var child = element.childNodes[i];
        if (attemptFocus(child) || focusLastDescendant(child)) {
          return true;
        }
      }
      return false;
    }

    function toggleModal(modal, sourceEl, open) {
      if (modal && modal.classList.contains('p-modal')) {
        if (typeof open === 'undefined') {
          open = modal.style.display === 'none';
        }

        if (open) {
          currentDialog = modal;
          modal.style.display = 'flex';
          focusFirstDescendant(modal);
          focusAfterClose = sourceEl;
          document.addEventListener('focus', trapFocus, true);
        } else {
          modal.style.display = 'none';
          if (focusAfterClose && focusAfterClose.focus) {
            focusAfterClose.focus();
          }
          document.removeEventListener('focus', trapFocus, true);
          currentDialog = null;
        }
      }
    }

    // Find and hide all modals on the page
    function closeModals() {
      var modals = [].slice.apply(document.querySelectorAll('.p-modal'));
      modals.forEach(function(modal) {
        toggleModal(modal, false, false);
      });
    }

    // Add click handler for clicks on elements with aria-controls
    document.addEventListener('click', function(event) {
      console.log(event);
      var targetControls = event.target.getAttribute('aria-controls');
      if (targetControls) {
        toggleModal(document.getElementById(targetControls), event.target);
      }
    });

    // Add handler for closing modals using ESC key.
    document.addEventListener('keydown', function(e) {
      e = e || window.event;

      if (e.code === 'Escape') {
        closeModals();
      } else if (e.keyCode === 27) {
        closeModals();
      }
    });

    // init the dialog that is initially opened in the example
    toggleModal(document.querySelector('#modal'), document.querySelector('[aria-controls=modal]'), false);
  })();
</script>
