{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Credentials -- Your exams{% endblock %}

{% block meta_description %}The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
Ubuntu Desktop, and Ubuntu Server topics.{% endblock meta_description %}
{% block meta_copydoc %}https://docs.google.com/document/d/1QuhO-9FEOGLrYp8bErS_9snqdljl7d6tFAUoNQxoVDQ/edit{% endblock
meta_copydoc %}

{% block content %}


<section class="p-strip">
    <div class="row--50-50">
      <div class="col">
        <h1><strong>Manage exam attempts</strong></h1>
      </div>
      <div class="col">
        <p>
          The table below shows exam attempts you have purchased.
          <br/>
					To redeem an attempt, copy the associated key and paste it where
					the system asks you for the attempt key.
        </p>
      </div>
    </div>
  </section>
  <section class="p-strip u-no-padding--top">
    <div class="row">
		<div class="p-tabs">
			<div class="p-tabs__list js-tabbed-content" role="tablist" aria-label="Exam keys">
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="true" aria-controls="all-keys" id="all-keys-tab">All keys</button>
				</div>
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="false" aria-controls="unused-keys" id="unused-keys-tab" tabindex="-1">Unused keys</button>
				</div>
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="false" aria-controls="active-keys" id="active-keys-tab" tabindex="-1">Active keys</button>
				</div>
			</div>				
			<div tabindex="0" role="tabpanel" id="all-keys" aria-labelledby="all-keys-tab">
				<table aria-label="All keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for keyitem in keys %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key">
									<span id="exam-key-item-{{ keyitem['key'] }}">{{ keyitem["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ keyitem["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{% if keyitem["activatedBy"] %}
										{{ keyitem["activatedBy"] }}
									{% else %}
									<span>N/A &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
										<a onClick="refreshKey({{ keys }}, {{ keyitem }})" id="refresh-btn" data-key="{{ keyitem['key'] }}">
											<i class="p-icon--restart"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
									</span>
									<span>&emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
										<a href="/credentials/redeem/{{ keyitem['key'] }}?action=confirm">
											<i class="p-icon--video-play"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
									</span>
									{% endif %}
								</td>
								<td>
									{{ keyitem["productID"] }}
								</td>
								<td class="expiration-date">
									{{ keyitem["expirationDate"] }}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</div>
				</table>
			</div>

			<div tabindex="0" role="tabpanel" id="unused-keys" aria-labelledby="unused-keys-tab">
				<table aria-label="Unused keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for keyitem in keys %}
							{% if keyitem["activatedBy"] is not defined %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key">
									<span id="exam-key-item-{{ keyitem['key'] }}">{{ keyitem["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ keyitem["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									<span>N/A &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
										<a id="refresh-btn" data-key="{{ keyitem['key'] }}">
											<i class="p-icon--restart"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
									</span>
									<span>&emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
										<a href="/credentials/redeem/{{ keyitem['key'] }}?action=confirm">
											<i class="p-icon--video-play"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
									</span>
								</td>
								<td>
									{{ keyitem["productID"] }}
								</td>
								<td class="expiration-date">
									{{ keyitem["expirationDate"] }}
								</td>
							</tr>
							{% endif %}
							{% endfor %}
						</tbody>
					</div>
				</table>
			</div>

			<div tabindex="0" role="tabpanel" id="active-keys" aria-labelledby="active-keys-tab">
				<table aria-label="Active keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for keyitem in keys %}
							{% if keyitem["activatedBy"] %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key">
									<span id="exam-key-item-{{ keyitem['key'] }}">{{ keyitem["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ keyitem["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{{ keyitem["activatedBy"] }}
								</td>
								<td>
									{{ keyitem["productID"] }}
								</td>
								<td class="expiration-date">
									{{ keyitem["expirationDate"] }}
								</td>
							</tr>
							{% endif %}
							{% endfor %}
						</tbody>					
				</table>
			</div>
		</div>
	</div>
</section>

<script src="{{ versioned_static('js/dist/tabbedContent.js') }}"></script>

<script>	
	function formatDate(expirationDate) {
		formattedDate = new Date(expirationDate);
		return formattedDate.toString();
	};
	
	function formatExpirationDates() {
		const expirationDateElements = document.querySelectorAll('.expiration-date');
        expirationDateElements.forEach(element => {
			const expirationDate = element.textContent.trim();
            const formattedExpirationDate = formatDate(expirationDate);
            element.textContent = formattedExpirationDate;
        });
	};
	
	// Format expiration dates on page load
	document.addEventListener('DOMContentLoaded', function () {
		formatExpirationDates();
	});

	const copyToClipboard = (value) => {
		navigator.clipboard.writeText(value);
  	};

	async function refreshKey(keys, keyItem) {
		oldKey = keyItem["key"];
		newKey = await rotateKey(oldKey);
		newActivationKey = newKey['activationKey'];

		keyItem['key'] = newActivationKey;

		keys.forEach(key => {
			if (key['key'] == oldKey) {
				const keyElement = document.getElementById('exam-key-item-' + oldKey);

				keyElement.id = 'exam-key-item-' + newActivationKey;
				keyElement.innerHTML = newActivationKey;
				key['key'] = newActivationKey;
			}		
		});		
	}

	async function rotateKey(activationKey) {
		let response = await fetch(`/credentials/keys/rotate/${activationKey}`, {
			method: "GET",
			headers: {
			Accept: "application/json",
			"Content-Type": "application/json",
			},
		});
		const data = await response.json();
		return data;
	}

</script>

{% endblock content%}