{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Credentials -- Your exams{% endblock %}

{% block meta_description %}The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
Ubuntu Desktop, and Ubuntu Server topics.{% endblock meta_description %}
{% block meta_copydoc %}https://docs.google.com/document/d/1QuhO-9FEOGLrYp8bErS_9snqdljl7d6tFAUoNQxoVDQ/edit{% endblock
meta_copydoc %}

{% block content %}

<section class="p-strip">
  <div class="row">
    <div class="col-6">
      <h1><strong>Manage exam attempts</strong></h1>
    </div>
    <div class="col-6">
      <p>
        The table below shows exam attempts you have purchased.
        <br/>
        To redeem an attempt, copy the associated key and paste it where
        the system asks you for the attempt key.
      </p>
    </div>
  </div>
</section>
<section class="p-strip u-no-padding--top">
  <div class="row">
    <div class="row--50-50">
      <div class="col"></div>
      <div class="col" style="display:flex; justify-content: flex-end; align-items: center;">
        <form>
          <select name="exam-keys" aria-label="Exam keys" id="keys_dropdown">
            <option {{ 'selected' if tab == '' else '' }} value="">All keys</option>
            <option {{ 'selected' if tab == 'unused' else '' }} value="unused">Unused keys</option>
            <option {{ 'selected' if tab == 'active' else '' }} value="active">Active keys</option>
          </select>
        </form>
      </div>
    </div>
    <div class="row">
      {% if not keys %}
        <p>No keys available.</p>
      {% else %}
      <table aria-label="Exam keys table" id="keys-table">
        <thead>
          <tr>
            <th>
              <form>
                <label class="p-checkbox">
                  <input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms"/>
                  <span class="p-checkbox__label"></span>
                </label>
              </form>
            </th>
            <th colspan="2">Exam Key Id</th>
            <th colspan="2">Assignee</th>
            <th>Exam</th>
            <th>Expiration Date</th>
          </tr>
        </thead>
        <tbody>
          {% for key_item in keys %}
            <tr>
              <td>
                <label class="p-checkbox">
                  <input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms"/>
                  <span class="p-checkbox__label"></span>
                </label>
              </td>
              <td colspan="2" class="has-overflow" id="exam-key-{{ key_item['index'] }}">
                <span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }}&emsp;</span>
                <span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
                  <a onClick="copyToClipboard('{{ key_item["key"] }}')">
                    <i class="p-icon--copy"></i>
                  </a>
                  <span class="p-tooltip__message" role="tooltip" id="copy-tooltip-{{ key_item['key'] }}">Copy Key</span>
                </span>
              </td>
              <td colspan="2" class="has-overflow">
                {% if key_item["activatedBy"] %}
                  {{ key_item["activatedBy"] }}
                {% else %}
                  <span>N/A &emsp;</span>
                  {% if not key_item["expired"] %}
                    <span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
                      <a onClick="refreshKey({{ key_item['index'] }})" id="refresh-btn">
                        <i class="p-icon--restart"></i>
                      </a>
                      <span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
                    </span>
                    <span>&emsp;</span>
                    <span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
                      <a href="/credentials/redeem/{{ key_item['key'] }}?action=confirm">
                        <i class="p-icon--video-play"></i>
                      </a>
                      <span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
                    </span>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {{ key_item["productID"] }}
              </td>
              <td class="expiration-date">
                {{ key_item["expirationDate"] }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <section class="p-strip is-shallow">
        {% with %}
          {% set total_pages = total_pages %}
          {% set offset = offset %}
          {% set current_page = page %}

          {% include "shared/_pagination.html" %}
        {% endwith %}
      </section>
      {% endif %}
    </div>
  </div>
</section>

<script>
  const copyToClipboard = (keyValue) => {
    const tempInput = document.createElement('input');
    tempInput.value = keyValue;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy')
    document.body.removeChild(tempInput);

    const copyTooltip = document.getElementById("copy-tooltip-" + keyValue);
    copyTooltip.innerHTML = "Copied!";

  };

  const keysDropdown = document.querySelector("#keys_dropdown");
  if (keysDropdown) {
    keysDropdown.addEventListener("change", (event) => {
      const url = new URL(window.location.href);
      if (keysDropdown.value === "") {
        url.searchParams.delete("tab");
      } else {
        url.searchParams.set("tab", keysDropdown.value);
      }
      url.searchParams.delete("page");
      window.location.href = url.toString();

    });
  }

  async function refreshKey(key_index) {
    const keysTable = document.getElementById("keys-table");
    const currentKey = getKey(keysTable, key_index);

    const oldActivationKey = currentKey.id.split('exam-key-item-')[1];
    const newKey = await rotateKey(oldActivationKey);
    const newActivationKey = newKey["activationKey"];
    currentKey.id = 'exam-key-item-' + newActivationKey;
    currentKey.innerHTML = newActivationKey + '&emsp;';
  }

  function getKey(keyTab, index) {
    const keyElement = keyTab.querySelector('#exam-key-' + index);
    if (keyElement) {
      const keys = keyElement.querySelector('span');
      return keys;
    }
  }

  async function rotateKey(activationKey) {
    let response = await fetch(`/credentials/keys/rotate/${activationKey}`, {
      method: "GET",
      headers: {
      Accept: "application/json",
      "Content-Type": "application/json",
      },
    });
    const data = await response.json();

    return data;
  }

  function updateKey(key, activationKey) {
    key.id = 'exam-key-item-' + activationKey;
    key.innerHTML = activationKey + '&emsp;';
  }
</script>
{% endblock content %}
