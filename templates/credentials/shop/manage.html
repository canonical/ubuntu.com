{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Credentials -- Your exams{% endblock %}

{% block meta_description %}The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
Ubuntu Desktop, and Ubuntu Server topics.{% endblock meta_description %}
{% block meta_copydoc %}https://docs.google.com/document/d/1QuhO-9FEOGLrYp8bErS_9snqdljl7d6tFAUoNQxoVDQ/edit{% endblock
meta_copydoc %}

{% block content %}


<section class="p-strip">
    <div class="row--50-50">
      <div class="col">
        <h1><strong>Manage exam attempts</strong></h1>
      </div>
      <div class="col">
        <p>
          The table below shows exam attempts you have purchased.
          <br/>
					To redeem an attempt, copy the associated key and paste it where
					the system asks you for the attempt key.
        </p>
      </div>
    </div>
  </section>
  <section class="p-strip u-no-padding--top">
    <div class="row">
		<div class="p-tabs">
			<div class="p-tabs__list js-tabbed-content" role="tablist" aria-label="Exam keys">
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="true" aria-controls="all-keys" id="all-keys-tab">All keys</button>
				</div>
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="false" aria-controls="unused-keys" id="unused-keys-tab" tabindex="-1">Unused keys</button>
				</div>
				<div class="p-tabs__item">
					<button class="p-tabs__link" role="tab" aria-selected="false" aria-controls="active-keys" id="active-keys-tab" tabindex="-1">Active keys</button>
				</div>
			</div>
			
			{% if not keys %}
				<p>No keys available.</p>
			{% else %}
			<div tabindex="0" role="tabpanel" id="all-keys" aria-labelledby="all-keys-tab">
				<table aria-label="All keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in keys %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key-{{ key_item['index']}}">
									<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ key_item["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{% if key_item["activatedBy"] %}
										{{ key_item["activatedBy"] }}
									{% else %}
									<span>N/A &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
										<a onClick="refreshKey({{ key_item }})" id="refresh-btn">
											<i class="p-icon--restart"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
									</span>
									<span>&emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
										<a href="/credentials/redeem/{{ key_item['key'] }}?action=confirm">
											<i class="p-icon--video-play"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
									</span>
									{% endif %}
								</td>
								<td>
									{{ key_item["productID"] }}
								</td>
								<td class="expiration-date">
									{{ key_item["expirationDate"] }}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</div>
				</table>
			</div>

			<div tabindex="0" role="tabpanel" id="unused-keys" aria-labelledby="unused-keys-tab">
				<table aria-label="Unused keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in keys %}
								{% if key_item["activatedBy"] is not defined %}
									<tr>
										<td>
											<label class="p-checkbox">
												<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
												<span class="p-checkbox__label"></span>
											</label>
										</td>
										<td colspan="2" class="has-overflow" id="exam-key-{{ key_item['index']}}">
											<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
												<a onClick="copyToClipboard('{{ key_item["key"] }}')">
													<i class="p-icon--copy"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
											</span>
										</td>
										<td colspan="2">
											<span>N/A &emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
												<a id="refresh-btn">
													<a onClick="refreshKey({{ key_item }})" id="refresh-btn">
													<i class="p-icon--restart"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
											</span>
											<span>&emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
												<a href="/credentials/redeem/{{ key_item['key'] }}?action=confirm">
													<i class="p-icon--video-play"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
											</span>
										</td>
										<td>
											{{ key_item["productID"] }}
										</td>
										<td class="expiration-date">
											{{ key_item["expirationDate"] }}
										</td>
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
					</div>
				</table>
			</div>

			<div tabindex="0" role="tabpanel" id="active-keys" aria-labelledby="active-keys-tab">
				<table aria-label="Active keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in keys %}
							{% if key_item["activatedBy"] %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key">
									<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ key_item["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{{ key_item["activatedBy"] }}
								</td>
								<td>
									{{ key_item["productID"] }}
								</td>
								<td class="expiration-date">
									{{ key_item["expirationDate"] }}
								</td>
							</tr>
							{% endif %}
							{% endfor %}
						</tbody>					
				</table>
			</div>
			{% endif %}
		</div>
	</div>
</section>

<script src="{{ versioned_static('js/dist/tabbedContent.js') }}"></script>

<script>
	const copyToClipboard = (value) => {
		navigator.clipboard.writeText(value);
	};

	async function refreshKey(key_item) {
		const allKeysTab = document.getElementById('all-keys');
		const unusedKeysTab = document.getElementById('unused-keys');

		const allKeys  = getKey(allKeysTab, key_item['index']);
		const unusedKeys = getKey(unusedKeysTab, key_item['index']);

		const oldActivationKey = allKeys.id.split('exam-key-item-')[1];
		newKey = await rotateKey(oldActivationKey);
		newActivationKey = newKey["activationKey"];		

		updateKey(allKeys, newActivationKey);
		updateKey(unusedKeys, newActivationKey);
	}

	function getKey(keyTab, index) {
		const keyElement = keyTab.querySelector('#exam-key-' + index);
		const keys = keyElement.querySelector('span');
		return keys;
	}
	
	async function rotateKey(activationKey) {
		let response = await fetch(`/credentials/keys/rotate/${activationKey}`, {
			method: "GET",
			headers: {
			Accept: "application/json",
			"Content-Type": "application/json",
			},
		});
		const data = await response.json();
		return data;
	}
	
	function updateKey(key, activationKey) {
		key.id = 'exam-key-item-' + activationKey;
		key.innerHTML = activationKey + '&emsp;';
	}

</script>

{% endblock content%}