{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Credentials -- Your exams{% endblock %}

{% block meta_description %}The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
Ubuntu Desktop, and Ubuntu Server topics.{% endblock meta_description %}
{% block meta_copydoc %}https://docs.google.com/document/d/1QuhO-9FEOGLrYp8bErS_9snqdljl7d6tFAUoNQxoVDQ/edit{% endblock
meta_copydoc %}

{% block content %}

<section class="p-strip">
    <div class="row">
      <div class="col-6">
        <h1><strong>Manage exam attempts</strong></h1>
      </div>
      <div class="col-6">
        <p>
          The table below shows exam attempts you have purchased.
          <br/>
					To redeem an attempt, copy the associated key and paste it where
					the system asks you for the attempt key.
        </p>
      </div>
    </div>
  </section>
  <section class="p-strip u-no-padding--top">
    <div class="row">
		<div class="p-tabs">
			<div class="p-tabs__list js-tabbed-content" data-maintain-hash="true" role="tablist" aria-label="Exam keys">
				<div class="p-tabs__item">
					<a href="#all" class="p-tabs__link" role="tab" aria-selected="true" aria-controls="all-keys" id="all-keys-tab">All keys</a>
				</div>
				<div class="p-tabs__item">
					<a href="#unused" class="p-tabs__link" role="tab" aria-controls="unused-keys" id="unused-keys-tab">Unused keys</a>
				</div>
				<div class="p-tabs__item">
					<a href="#active" class="p-tabs__link" role="tab" aria-controls="active-keys" id="active-keys-tab">Active keys</a>
				</div>
			</div>						
			
			{% if not keys %}
				<p>No keys available.</p>
			{% else %}
			<div tabindex="0" role="tabpanel" id="all-keys" aria-labelledby="all-keys-tab">
				<table aria-label="All keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in all["keys"] %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key-{{ key_item['index']}}">
									<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ key_item["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{% if key_item["activatedBy"] %}
										{{ key_item["activatedBy"] }}
									{% else %}
									<span>N/A &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
										<a onClick="refreshKey({{ key_item }}, 'all-keys')" id="refresh-btn">
											<i class="p-icon--restart"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
									</span>
									<span>&emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
										<a href="/credentials/redeem/{{ key_item['key'] }}?action=confirm">
											<i class="p-icon--video-play"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
									</span>
									{% endif %}
								</td>
								<td>
									{{ key_item["productID"] }}
								</td>
								<td class="expiration-date">
									{{ key_item["expirationDate"] }}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</div>
				</table>
				<section class="p-strip is-shallow">
					{% with %} 
						{% set total_pages = all["total_pages"] %}
						{% set offset = offset %}					
						{% set current_tab = "all" %}
						{% set current_page = all["page_no"] %}
						{% set all_page_no = all["page_no"] %}
						{% set unused_page_no = unused["page_no"] %}
						{% set active_page_no = active["page_no"] %}

						{% include "credentials/shop/_pagination.html" %}
					{% endwith %}
				</section>
			</div>

			<div tabindex="0" role="tabpanel" id="unused-keys" aria-labelledby="unused-keys-tab">
				<table aria-label="Unused keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in unused["keys"] %}
								{% if key_item["activatedBy"] is not defined %}
									<tr>
										<td>
											<label class="p-checkbox">
												<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
												<span class="p-checkbox__label"></span>
											</label>
										</td>
										<td colspan="2" class="has-overflow" id="exam-key-{{ key_item['index']}}">
											<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
												<a onClick="copyToClipboard('{{ key_item["key"] }}')">
													<i class="p-icon--copy"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
											</span>
										</td>
										<td colspan="2">
											<span>N/A &emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="refresh-tooltip">
												<a id="refresh-btn">
													<a onClick="refreshKey({{ key_item }}, 'unused-keys')" id="refresh-btn">
													<i class="p-icon--restart"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="refresh-tooltip">Refresh Key</span>
											</span>
											<span>&emsp;</span>
											<span class="p-tooltip--btm-center" aria-describedby="redeem-tooltip">
												<a href="/credentials/redeem/{{ key_item['key'] }}?action=confirm">
													<i class="p-icon--video-play"></i>
												</a>
												<span class="p-tooltip__message" role="tooltip" id="redeem-tooltip">Redeem Key</span>
											</span>
										</td>
										<td>
											{{ key_item["productID"] }}
										</td>
										<td class="expiration-date">
											{{ key_item["expirationDate"] }}
										</td>
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
					</div>
				</table>
				<section class="p-strip is-shallow">
					{% with %} 
						{% set total_pages = unused["total_pages"] %}
						{% set offset = offset %}
						{% set current_tab = "unused" %}
						{% set current_page = unused["page_no"] %}
						{% set all_page_no = all["page_no"] %}
						{% set unused_page_no = unused["page_no"] %}
						{% set active_page_no = active["page_no"] %}

						{% include "credentials/shop/_pagination.html" %}
					{% endwith %}
				</section>
			</div>

			<div tabindex="0" role="tabpanel" id="active-keys" aria-labelledby="active-keys-tab">
				<table aria-label="Active keys table">
					<div class="row">
						<thead>
							<tr>
								<th>
									<form>
										<label class="p-checkbox">
											<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
											<span class="p-checkbox__label"></span>
										</label>
									</form>
								</th>
								<th colspan="2">Exam Key Id</th>
								<th colspan="2">Assignee</th>
								<th>Exam</th>
								<th>Expiration Date</th>
							</tr>
						</thead>
						<tbody>
							{% for key_item in active["keys"] %}
							{% if key_item["activatedBy"] %}
							<tr>
								<td>
									<label class="p-checkbox">
										<input class="p-checkbox__input" type="checkbox" aria-labelledby="renewal-terms">
										<span class="p-checkbox__label"></span>
									</label>
								</td>
								<td colspan="2" class="has-overflow" id="exam-key">
									<span id="exam-key-item-{{ key_item['key'] }}">{{ key_item["key"] }} &emsp;</span>
									<span class="p-tooltip--btm-center" aria-describedby="copy-tooltip">
										<a onClick="copyToClipboard('{{ key_item["key"] }}')">
											<i class="p-icon--copy"></i>
										</a>
										<span class="p-tooltip__message" role="tooltip" id="copy-tooltip">Copy Key</span>
									</span>
								</td>
								<td colspan="2">
									{{ key_item["activatedBy"] }}
								</td>
								<td>
									{{ key_item["productID"] }}
								</td>
								<td class="expiration-date">
									{{ key_item["expirationDate"] }}
								</td>
							</tr>
							{% endif %}
							{% endfor %}
						</tbody>					
				</table>
				<section class="p-strip is-shallow">
					{% with %} 
						{% set total_pages = active["total_pages"] %}
						{% set offset = offset %}						
						{% set current_tab = "active" %}
						{% set current_page = active["page_no"] %}
						{% set all_page_no = all["page_no"] %}
						{% set unused_page_no = unused["page_no"] %}
						{% set active_page_no = active["page_no"] %}

						{% include "credentials/shop/_pagination.html" %}
					{% endwith %}
				</section>
			</div>
			{% endif %}
		</div>
	</div>
</section>

<script>
	const currentTab = "{{ current_tab }}";
	if (currentTab) {
		window.location.hash = currentTab;
	}

	const copyToClipboard = (value) => {
		navigator.clipboard.writeText(value);
	};

	async function refreshKey(key_item, key_tab) {
		const currentTab = document.getElementById(key_tab);
		var otherTab;
		if (key_tab == 'all-keys') {
			otherTab = document.getElementById('unused-keys');
		} else {
			otherTab = document.getElementById('all-keys');
		}
		const currentKeys = getKey(currentTab, key_item['index']);		
		const oldActivationKey = currentKeys.id.split('exam-key-item-')[1];
		const newKey = await rotateKey(oldActivationKey);
		const newActivationKey = newKey["activationKey"];
		
		updateKey(currentKeys, newActivationKey);
		const otherKeys = getKey(otherTab, key_item['index']);
		if (otherKeys) {
			updateKey(otherKeys, newActivationKey);
		}
	}

	function getKey(keyTab, index) {
		const keyElement = keyTab.querySelector('#exam-key-' + index);
		if (keyElement) {
			const keys = keyElement.querySelector('span');
			return keys;
		}
	}
	
	async function rotateKey(activationKey) {
		let response = await fetch(`/credentials/keys/rotate/${activationKey}`, {
			method: "GET",
			headers: {
			Accept: "application/json",
			"Content-Type": "application/json",
			},
		});
		const data = await response.json();
		return data;
	}
	
	function updateKey(key, activationKey) {
		key.id = 'exam-key-item-' + activationKey;
		key.innerHTML = activationKey + '&emsp;';
	}
</script>

<script src="{{ versioned_static('js/dist/tabbedContent.js') }}"></script>
{% endblock content%}