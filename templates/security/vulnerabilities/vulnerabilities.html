{% extends "security/base_security.html" %}

{% block title %}Vulnerabilities | document.title{% endblock %}

{% block meta_description %}{{ document.sections[0].title }}{% endblock %}

{% block body_class %}
  is-paper
{% endblock body_class %}

{% block content %}
  <div class="p-strip is-shallow u-no-padding--bottom">
    <div class="u-fixed-width">
      <a href="/security/vulnerabilities" class="p-link--soft">&lang;&nbsp;&nbsp;&nbsp;Back to all vulnerabilities</a>
    </div>
  </div>
  <div class="p-section">
    <div class="row--25-75">
      <div class="col">
        <div class="p-section">
          <div class="p-section--shallow">
            <h1>{{ document.title }}</h1>
            <p class="p-heading--3 section-heading" id="description">{{ document.sections[0].title }}</p>
            <div class="row">
              <div class="col-2">
                <p class="u-no-margin--bottom u-sv1">Published</p>
              </div>
              <div class="col-2">
                <p class="u-no-margin--bottom u-sv1">{{ format_date(metadata.published) }}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-2">Updated</div>
              <div class="col-2">{{ document.updated }}</div>
            </div>
          </div>
          <hr class="p-rule" />
        </div>
      </div>
    </div>
    <div class="row--25-75">
      {% if document.sections|length > 1 %}
        <div class="col">
          <div class="p-side-navigation--raw-html u-hide--small u-hide--medium"
               id="drawer"
               style="position: sticky;
                      top: 4rem">
            <button class="p-side-navigation__toggle js-drawer-toggle"
                    aria-controls="drawer">Toggle side navigation</button>
            <div class="p-side-navigation__overlay js-drawer-toggle"
                 aria-controls="drawer"></div>
            <nav class="p-side-navigation__drawer"
                 aria-label="documentation side navigation">
              <div class="p-side-navigation__drawer-header">
                <button class="p-side-navigation__toggle--in-drawer js-drawer-toggle"
                        aria-controls="drawer">Toggle table of contents</button>
              </div>
              <ul>
                {% for section in document.sections %}
                  <li class="p-side-navigation__item">
                    {% if loop.first %}
                      <a class="highlight-link is-active" href="#description">Description</a>
                    {% else %}
                      <a class="highlight-link" href="#{{ format_to_id(section.title) }}">{{ section.title }}</a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </nav>
          </div>
        </div>
      {% endif %}
      <div class="col">
        {% for section in document.sections %}
          <div class="p-section--shallow">
            {% if not loop.first %}
              <hr class="p-rule" />
              <h2 class="p-heading--3 section-heading"
                  id="{{ format_to_id(section.title) }}">{{ section.title }}</h2>
            {% endif %}
            {{ section.content | safe }}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    function setUpDynamicSideNav() {
      const sections = Array.prototype.slice.call(
        document.querySelectorAll(".section-heading")
      );

      const navigationLinks = Array.prototype.slice.call(
        document.querySelectorAll(".highlight-link")
      );

      sections.forEach(function(section) {
        const observer = new IntersectionObserver(function(entry) {
          if (entry[0].isIntersecting) {
            const sectionId = entry[0].target.id;
            navigationLinks.forEach(function(link) {
              if (link.getAttribute("href") === `#${sectionId}`) {
                link.classList.add("is-active");
              } else {
                link.classList.remove("is-active");
              }
            });
          }
        }, {
          rootMargin: "-200px 0px -400px",
          threshold: 0.5,
        });

        observer.observe(section);
      });
    };
    setUpDynamicSideNav();
  </script>
{% endblock content %}
