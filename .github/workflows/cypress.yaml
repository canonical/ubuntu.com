name: Cypress checks
on: pull_request
jobs:
  run-cypress:
    env:
      baseUrl: http://0.0.0.0:8001
      UBUNTU_USERNAME: ${{secrets.CYPRESS_UBUNTU_USERNAME}}
      UBUNTU_PASSWORD: ${{secrets.CYPRESS_UBUNTU_PASSWORD}}
      SECRET_KEY: insecure_test_key
      DATABASE_URL: postgres://postgres:pw@localhost:5432/postgres
      PORT: 8001
      CONTRACTS_LIVE_API_URL: contracts.canonical.com

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: pw
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    if: github.repository == 'canonical-web-and-design/ubuntu.com'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

    - run: 'echo "$UBUNTU_USERNAME" > UBUNTU_USERNAME'
      shell: bash
      env:
        UBUNTU_USERNAME: ${{secrets.CYPRESS_UBUNTU_USERNAME}}

      # - name: Install python dependencies
      #   run: pip3 install -r requirements.txt

      # - name: Cypress run
      #   uses: cypress-io/github-action@v2
      #   with:
      #     command: npx cypress run --config-file tests/cypress/cypress.json --config baseUrl=${{env.baseUrl}} --env UBUNTU_USERNAME=${{ env.UBUNTU_USERNAME }},UBUNTU_PASSWORD=${{ env.UBUNTU_PASSWORD }}
      #     build: yarn run build
      #     start: yarn run serve
      #     wait-on: "${{env.baseUrl}}/_status/check"
      #     wait-on-timeout: 180
      #     browser: chrome
